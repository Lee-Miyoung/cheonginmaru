<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>청인마루 통합 시스템 v73.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@100;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #F8FAFC; color: #334155; -webkit-tap-highlight-color: transparent; }
        .card-clean { background: white; border-radius: 30px; padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.02); border: 1px solid #F1F5F9; margin-bottom: 24px; }
        .input-field { width: 100%; padding: 16px; background: #F1F5F9; border-radius: 16px; border: 1px solid transparent; font-weight: 700; font-size: 15px; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: #2563EB; background: white; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        .input-label { display: block; font-size: 11px; font-weight: 900; color: #94A3B8; margin-bottom: 8px; margin-left: 4px; text-transform: uppercase; }
        
        .tab-btn { flex: 1; padding: 14px; border-radius: 14px; font-size: 14px; font-weight: 900; text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid transparent; color: #94A3B8; }
        .tab-btn.active-floor { background: #DBEAFE; color: #2563EB; border-color: #BFDBFE; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
        .tab-btn.active-wall { background: #F3E8FF; color: #9333EA; border-color: #E9D5FF; box-shadow: 0 4px 12px rgba(147, 51, 234, 0.1); }
        .tab-btn.active-measure { background: #E0E7FF; color: #4F46E5; border-color: #C7D2FE; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1); }

        .master-layout { display: grid; grid-template-columns: 1fr; gap: 24px; max-width: 1400px; margin: 0 auto; }
        @media (min-width: 1024px) { .master-layout { grid-template-columns: 1.15fr 0.85fr; align-items: start; } }

        .report-dark { background: #111827; color: white; border-radius: 40px; padding: 40px; position: sticky; top: 20px; }
        .total-box { background: #2563EB; border-radius: 25px; padding: 24px; text-align: center; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3); }
        
        .type-btn-active { background: #2563EB; color: white; }
        .type-btn-inactive { background: #F1F5F9; color: #64748B; }
        .exp-card-active { border: 2px solid #2563EB; background: #EFF6FF; }
        .exp-card-inactive { border: 1px solid #E2E8F0; background: white; }
    </style>
</head>
<body>

    <div class="p-6">
        <header class="max-w-6xl mx-auto mb-10 text-center">
            <h1 class="text-4xl font-black text-slate-900 tracking-tighter mb-1">청인마루.</h1>
            <div class="text-[14px] font-bold text-slate-400">Smart Quote v73.2 | <span class="text-blue-500">실시간 통합 견적 시스템</span></div>
        </header>

        <div class="master-layout">
            <div class="input-forms">
                <div class="flex gap-2 mb-8 bg-slate-100 p-1.5 rounded-2xl">
                    <button id="tab-floor" onclick="setMode('floor')" class="tab-btn active-floor">마루/바닥재</button>
                    <button id="tab-wall" onclick="setMode('wall')" class="tab-btn inactive">벽장재</button>
                    <button id="tab-measure" onclick="setMode('measure')" class="tab-btn inactive">실측전용</button>
                </div>

                <div id="floor-wrapper">
                    <div class="card-clean">
                        <label class="input-label">자재 및 면적 설정</label>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <select id="floor-brand" class="input-field" onchange="updateFloorProducts()"></select>
                            <select id="floor-product" class="input-field" onchange="handleFloorProduct()"></select>
                        </div>
                        
                        <div id="product-detail-info" class="mb-6 p-4 bg-slate-50 rounded-2xl hidden border border-dashed border-slate-200">
                            <div class="flex justify-between items-center text-sm font-bold">
                                <span id="display-model" class="text-slate-700">-</span>
                                <span id="display-spec" class="text-blue-600">-</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-white border border-slate-200 rounded-2xl p-4 text-center">
                                <label class="input-label text-blue-500">공급 평형</label>
                                <div class="flex items-baseline justify-center"><input id="f-supply-py" type="number" step="0.1" class="w-16 text-center font-black text-2xl outline-none" placeholder="0" oninput="syncFPy()"><span class="text-sm font-bold text-slate-400 ml-1">평</span></div>
                            </div>
                            <div class="bg-white border border-slate-200 rounded-2xl p-4 text-center">
                                <label class="input-label text-green-500">공급 면적</label>
                                <div class="flex items-baseline justify-center"><input id="f-supply-m2" type="number" step="0.1" class="w-20 text-center font-black text-2xl outline-none" placeholder="0" oninput="syncFM2()"><span class="text-sm font-bold text-slate-400 ml-1">㎡</span></div>
                            </div>
                        </div>

                        <div id="res-options" class="flex gap-3 mb-6">
                            <div onclick="setExp(true)" id="btn-exp" class="flex-1 p-4 rounded-2xl cursor-pointer exp-card-active text-center"><div class="text-[9px] font-black uppercase mb-1">Expanded</div><div class="text-lg font-black text-blue-700">확장 (0.8)</div></div>
                            <div onclick="setExp(false)" id="btn-nexp" class="flex-1 p-4 rounded-2xl cursor-pointer exp-card-inactive text-center"><div class="text-[9px] font-black uppercase mb-1">Basic</div><div class="text-lg font-black text-slate-600">비확장 (0.75)</div></div>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-100 rounded-2xl p-5 flex justify-between items-center mb-6">
                            <span class="text-sm font-black text-yellow-700">BOX 단가</span>
                            <input id="floor-price" class="bg-transparent text-right font-black text-2xl text-yellow-600 outline-none w-40" placeholder="0" oninput="formatNum(this); calcFloor()">
                        </div>
                    </div>

                    <div class="card-clean">
                        <label class="input-label">Options & Labor (추가 옵션)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 ml-1">철거비(평)</label>
                                <input type="text" id="opt-removal" class="input-field text-right" placeholder="0" oninput="formatNum(this); calcFloor()">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 ml-1">걸레받이(평)</label>
                                <input type="text" id="opt-molding" class="input-field text-right" placeholder="0" oninput="formatNum(this); calcFloor()">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 ml-1">운반비</label>
                                <input type="text" id="opt-lifting" class="input-field text-right" placeholder="0" oninput="formatNum(this); calcFloor()">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 ml-1">기타/보양</label>
                                <input type="text" id="opt-etc" class="input-field text-right" placeholder="0" oninput="formatNum(this); calcFloor()">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="measure-wrapper" class="card-clean hidden">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-sm font-black uppercase text-indigo-600">Measurement</span>
                        <button onclick="connectBosch()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">BOSCH CONNECT</button>
                    </div>
                    <div class="bg-slate-50 rounded-3xl p-6 flex gap-3 items-center">
                        <input type="number" id="zone-w" class="input-field text-center text-2xl h-16" placeholder="W">
                        <span class="font-black text-slate-200">×</span>
                        <input type="number" id="zone-h" class="input-field text-center text-2xl h-16" placeholder="H">
                    </div>
                </div>
            </div>

            <div class="sticky-report">
                <div id="capture-area" class="report-dark shadow-2xl">
                    <div class="flex justify-between items-start mb-10">
                        <div><p class="text-[10px] font-black text-blue-400 uppercase tracking-widest">Quote Report</p><h2 class="text-3xl font-black">고객님 견적</h2></div>
                        <div class="text-right text-xl font-black">청인마루</div>
                    </div>
                    
                    <div class="space-y-6 mb-10">
                        <div>
                            <p class="text-[10px] font-black text-slate-500 uppercase">Product</p>
                            <h2 id="rep-prod" class="text-2xl font-black">제품 미선택</h2>
                            <p id="rep-spec-detail" class="text-xs text-blue-300 font-bold">-</p>
                        </div>
                        <div class="flex justify-between items-end border-b border-white/10 pb-4">
                            <span class="text-sm font-bold text-slate-400">발주 물량</span>
                            <div class="text-right"><span id="rep-boxes" class="text-4xl font-black text-blue-400">0</span><span class="text-lg font-bold text-slate-500 ml-1">BOX</span></div>
                        </div>
                    </div>

                    <div class="total-box">
                        <h2 class="text-5xl font-black text-white"><span id="val-total">0</span>원</h2>
                        <p class="text-[10px] font-black opacity-70 mt-2 uppercase tracking-tighter">Total Amount (VAT Included)</p>
                    </div>
                    
                    <p class="text-[11px] text-center text-slate-500 font-bold">※ 위 금액은 자재 및 옵션 비용이 모두 포함된 총액입니다.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const FLOOR_URL = "https://script.google.com/macros/s/AKfycbzp2kx3wOkbCEh1eTj9m5zKaCpXjMatk1KAjSVhh2OmBJhxjX-YedcI8CNVo0pj7zPs/exec";
        let masterData=[], mode='floor', floorExp=true;

        window.onload = () => { loadData(); };

        function syncFPy() {
            const py = parseFloat(document.getElementById('f-supply-py').value) || 0;
            document.getElementById('f-supply-m2').value = (py * 3.3058).toFixed(1);
            calcFloor();
        }
        function syncFM2() {
            const m2 = parseFloat(document.getElementById('f-supply-m2').value) || 0;
            document.getElementById('f-supply-py').value = (m2 / 3.3058).toFixed(1);
            calcFloor();
        }

        async function loadData() {
            try {
                const r = await fetch(FLOOR_URL);
                const d = await r.json();
                let brands = {};
                d.forEach(i => {
                    if(!brands[i.brand]) brands[i.brand] = { brand: i.brand, products: [] };
                    brands[i.brand].products.push(i);
                });
                masterData = Object.values(brands);
                updateBrandSelects();
            } catch(e) { console.error("Data Load Error"); }
        }

        function updateBrandSelects() {
            const sel = document.getElementById('floor-brand');
            sel.innerHTML = '<option value="">브랜드 선택</option>';
            masterData.forEach(m => sel.add(new Option(m.brand, m.brand)));
        }

        function updateFloorProducts() {
            const bName = document.getElementById('floor-brand').value;
            const pSel = document.getElementById('floor-product');
            pSel.innerHTML = '<option value="">제품군 선택</option>';
            const brand = masterData.find(x => x.brand === bName);
            if(brand) brand.products.forEach((p, i) => pSel.add(new Option(p.name, i)));
        }

        function handleFloorProduct() {
            const bName = document.getElementById('floor-brand').value;
            const pIdx = document.getElementById('floor-product').value;
            if(pIdx === "") return;
            const p = masterData.find(x => x.brand === bName).products[pIdx];
            document.getElementById('product-detail-info').style.display = 'block';
            document.getElementById('display-model').innerText = p.name;
            document.getElementById('display-spec').innerText = p.spec || '';
            document.getElementById('floor-price').value = parseInt(p.price).toLocaleString();
            document.getElementById('rep-prod').innerText = p.brand + " " + p.name;
            document.getElementById('rep-spec-detail').innerText = p.spec;
            calcFloor();
        }

        function calcFloor() {
            // 1. 기본 면적 및 수량 계산
            const py = parseFloat(document.getElementById('f-supply-py').value) || 0;
            const factor = floorExp ? 0.8 : 0.75;
            const realPy = Math.ceil(py * factor);
            const boxPrice = parseInt(document.getElementById('floor-price').value.replace(/,/g, '')) || 0;
            const boxes = Math.ceil(((realPy * 3.3058) / 3.2) * 1.1);
            
            document.getElementById('rep-boxes').innerText = boxes;
            const materialTotal = boxes * boxPrice;

            // 2. [핵심] 옵션 및 인건비 계산
            const removal = (parseInt(document.getElementById('opt-removal').value.replace(/,/g, '')) || 0) * realPy;
            const molding = (parseInt(document.getElementById('opt-molding').value.replace(/,/g, '')) || 0) * py;
            const lifting = parseInt(document.getElementById('opt-lifting').value.replace(/,/g, '')) || 0;
            const etc = parseInt(document.getElementById('opt-etc').value.replace(/,/g, '')) || 0;

            // 3. 실시간 총액 업데이트 (VAT 10% 포함)
            const subTotal = materialTotal + removal + molding + lifting + etc;
            const finalTotal = Math.round(subTotal * 1.1);
            
            document.getElementById('val-total').innerText = finalTotal.toLocaleString();
        }

        function setMode(m) {
            mode = m;
            document.getElementById('floor-wrapper').classList.toggle('hidden', m !== 'floor');
            document.getElementById('measure-wrapper').classList.toggle('hidden', m !== 'measure');
            ['tab-floor', 'tab-wall', 'tab-measure'].forEach(id => {
                document.getElementById(id).className = id.includes(m) ? `tab-btn active-${m}` : 'tab-btn inactive';
            });
        }

        function setExp(v) {
            floorExp = v;
            document.getElementById('btn-exp').className = v ? 'flex-1 p-4 rounded-2xl cursor-pointer exp-card-active text-center' : 'flex-1 p-4 rounded-2xl cursor-pointer exp-card-inactive text-center';
            document.getElementById('btn-nexp').className = !v ? 'flex-1 p-4 rounded-2xl cursor-pointer exp-card-active text-center' : 'flex-1 p-4 rounded-2xl cursor-pointer exp-card-inactive text-center';
            calcFloor();
        }

        function formatNum(el) { el.value = el.value.replace(/[^0-9]/g,'').replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
        async function connectBosch() { alert("BOSCH 측정기 연결을 시도합니다."); }
    </script>
</body>
</html>
